# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger:
- master
- vNext

pool:
  vmImage: 'ubuntu-latest'

steps:
- task: Npm@1
  inputs:
    command: 'install'

- task: Npm@1
  displayName: 'Convert from a markdown to a html'
  inputs:
    command: 'custom'
    customCommand: 'run html'

- task: Bash@3
  displayName: 'Download vivliostyle'
  inputs:
    targetType: 'inline'
    script: |
      wget http://vivliostyle.github.io/vivliostyle.js/downloads/vivliostyle-js-latest.zip
      unzip vivliostyle-js-latest.zip
      rm vivliostyle-js-latest.zip 
      mv vivliostyle-* vivliostyle

- task: Bash@3
  displayName: 'Create web root'
  inputs:
    targetType: 'inline'
    script: |
      mkdir vivliostyle/viewer/src
      touch vivliostyle/viewer/src/.gitkeep
      mkdir vivliostyle/viewer/dist
      touch vivliostyle/viewer/dist/.gitkeep
      cp -r build/media vivliostyle/viewer/src/media
      cp build/book.html vivliostyle/viewer/src/book.html

- task: AzureCLI@1
  displayName: 'Copy files to a static web'
  inputs:
    azureSubscription: $(azureSubscription)
    scriptLocation: 'inlineScript'
    inlineScript: 'az storage blob upload-batch -s vivliostyle/viewer -d "$(azureBlobUrl)/\$web"'

- task: CmdLine@2
  displayName: 'Print pdf file'
  inputs:
    script: 'node build/buildPdf.js $(azureStaticWebUrl)'

- task: Bash@3
  displayName: 'Move the pdf to web root'
  inputs:
    targetType: 'inline'
    script: |
      mv build/guideline.pdf vivliostyle/viewer/dist/guideline-$(Build.SourceBranchName).pdf

- task: AzureCLI@1
  displayName: 'Push the pdf to static web'
  inputs:
    azureSubscription: $(azureSubscription)
    scriptLocation: 'inlineScript'
    inlineScript: 'az storage blob upload-batch -s vivliostyle/viewer -d "$(azureBlobUrl)/\$web"'
